<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Library - The Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora&family=Source+Sans+Pro&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #FDFDFD; font-family: 'Lora', serif; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        .ui-font { font-family: 'Source Sans Pro', sans-serif; }
        header { background-color: #001F3F; }
        .card-premium-unlocked { border-left: 4px solid #D4AF37; }
        .card-premium-locked { border-left: 4px solid #d1d5db; }
        .card-free { border-left: 4px solid #8A9A5B; }
    </style>
</head>
<body class="text-gray-800">

    <header class="text-white shadow-lg">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <a href="./academy.html" class="flex items-center gap-2">
                    <svg class="h-8 w-8" viewBox="0 0 24 24"><path d="M12 2 L2 22 H22 Z M12 6 L18.3 18 H5.7 Z" fill="#D4AF37"/></svg>
                    <span class="font-bold text-2xl">The Academy</span>
                </a>
                <div id="auth-nav" class="text-sm ui-font">
                    <a href="./login.html" class="font-bold hover:underline">Member Login</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h1 id="library-title" class="text-5xl font-bold text-gray-900" style="color: #001F3F;">The Library</h1>
                <p id="library-subtitle" class="mt-4 text-lg text-gray-600">Browse our collection of lessons on the craft of writing.</p>
            </div>
            <div id="library-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p class="ui-font col-span-full text-center text-gray-500">Loading lessons...</p>
            </div>
        </div>
    </main>

    <footer class="mt-24 py-8 text-center text-gray-400" style="background-color: #001F3F;">
        <p class="ui-font">¬© 2025 Boluadeoye ‚Ä¢ Crafted with passion</p>
    </footer>

    <script type="module">
        import { auth, database } from './auth.js';

        const authNav = document.getElementById('auth-nav');
        const libraryGrid = document.getElementById('library-grid');
        const libraryTitle = document.getElementById('library-title');
        const librarySubtitle = document.getElementById('library-subtitle');
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('view');

        // Update titles based on view filter
        if (view === 'scriptorium') {
            libraryTitle.textContent = 'The Scriptorium';
            librarySubtitle.textContent = 'Lessons focused on the mechanics and grammar of language.';
        } else if (view === 'lyceum') {
            libraryTitle.textContent = 'The Lyceum';
            librarySubtitle.textContent = 'Lessons focused on the study and appreciation of literature.';
        }
        
        function renderLessons(lessons, user) {
            libraryGrid.innerHTML = ''; // Clear loading state
            
            // CORRECTED LOGIC: Determine which tags to show if no view is specified.
            const defaultTags = ['scriptorium', 'lyceum'];
            const tagsToShow = view ? [view] : defaultTags;

            const filteredLessons = lessons.filter(topic => 
                topic.tags && topic.tags.some(tag => tagsToShow.includes(tag))
            );

            if (filteredLessons.length === 0) {
                 libraryGrid.innerHTML = '<p class="ui-font col-span-full text-center text-gray-500">No lessons found for this view.</p>';
                 return;
            }

            filteredLessons.forEach(topic => {
                const isPremium = topic.access === 'premium';
                const isLocked = isPremium && !user;
                
                let cardClass = isPremium ? (isLocked ? 'card-premium-locked' : 'card-premium-unlocked') : 'card-free';
                const card = document.createElement('a');
                card.href = isLocked ? './login.html' : `./lesson.html?id=${topic.id}`;
                card.className = `bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 block ${cardClass}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                         <h3 class="text-2xl font-bold pr-4" style="color: #001F3F;">${topic.title}</h3>
                         ${isPremium ? `<span class="flex-shrink-0 text-lg">${isLocked ? 'üîí' : '‚≠ê'}</span>` : ''}
                    </div>
                    <p class="text-gray-600 mt-2 text-base">${topic.summary}</p>
                    <div class="flex items-center justify-between mt-4 text-sm ui-font">
                        <span class="px-2 py-1 rounded text-xs font-bold ${topic.difficulty === 'Beginner' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${topic.difficulty}</span>
                        ${isPremium ? `<span class="font-bold" style="color: #D4AF37;">Premium</span>` : `<span class="font-bold" style="color: #8A9A5B;">Free</span>`}
                    </div>
                `;
                libraryGrid.appendChild(card);
            });
        }

        auth.onAuthStateChange(async (user) => {
            if (user) {
                authNav.innerHTML = `<button id="logout-btn" class="font-bold hover:underline" style="color: #D4AF37;">Logout</button>`;
                document.getElementById('logout-btn').addEventListener('click', () => auth.logout());
            } else {
                authNav.innerHTML = `<a href="./login.html" class="font-bold hover:underline">Member Login</a>`;
            }
            
            const { data: lessons, error } = await database.getLessons();
            if (error) {
                libraryGrid.innerHTML = '<p class="text-red-500">Error loading lessons. Please check your connection and refresh.</p>';
                console.error('Error fetching lessons:', error);
            } else if (lessons) {
                renderLessons(lessons, user);
            }
        });
    </script>
</body>
</html>
