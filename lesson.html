<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Viewer - The Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        :root {
            --bg-slate: #2D3748; --panel-cream: #F7FAFC; --accent-gold: #D69E2E; --accent-ink: #6A7A94;
            --text-dark: #2D3748; --text-muted: #718096; --font-body: 'Lora', serif; --font-ui: 'Inter', sans-serif;
            --success-green: #38A169; --error-red: #E53E3E; --intermediate-blue: #3182CE;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { background: var(--panel-cream); font-family: var(--font-ui); color: var(--text-dark); line-height: 1.6; }
        h1, h2, h3 { font-family: var(--font-body); }
        header { /* ... Unchanged ... */ }
        footer { /* ... Unchanged ... */ }

        /* --- NEW: Main Two-Column Layout --- */
        .lesson-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 48px;
            max-width: 1100px;
            margin: 48px auto;
            padding: 0 16px;
            align-items: start;
        }
        #lesson-container { max-width: 800px; }

        /* --- NEW: Table of Contents --- */
        #toc-container {
            position: sticky;
            top: 100px; /* Header height + margin */
        }
        #toc-container h3 { font-size: 18px; color: var(--accent-gold); margin-bottom: 12px; }
        #toc-container ul { list-style: none; }
        #toc-container a {
            display: block;
            padding: 8px;
            font-size: 15px;
            color: var(--text-muted);
            border-left: 2px solid #e2e8f0;
            transition: all 0.2s;
        }
        #toc-container a:hover { color: var(--accent-gold); border-left-color: var(--accent-gold); }

        /* --- Lesson Header & Metadata --- */
        #lesson-header { margin-bottom: 32px; border-bottom: 1px solid #e2e8f0; padding-bottom: 24px; }
        #lesson-header h1 { font-size: 42px; line-height: 1.1; margin-bottom: 8px; }
        #lesson-header p.summary { font-size: 18px; color: var(--text-muted); margin-bottom: 24px; }
        .metadata { display: flex; flex-wrap: wrap; gap: 16px 24px; font-size: 14px; font-weight: 500; }
        .metadata > span { display: inline-flex; align-items: center; gap: 6px; }
        .difficulty-beginner { color: var(--success-green); }
        .difficulty-intermediate { color: var(--intermediate-blue); }
        .difficulty-advanced { color: var(--accent-gold); }

        /* --- NEW: Guided Navigation sections --- */
        .nav-box {
            background: #fff; border: 1px solid #e2e8f0; border-left: 4px solid var(--accent-ink);
            padding: 16px; border-radius: 6px; margin-bottom: 32px;
        }
        .nav-box h3 { font-size: 16px; color: var(--text-dark); margin-bottom: 8px; }
        .nav-box a { color: var(--intermediate-blue); font-weight: 500; }
        .nav-box a:hover { text-decoration: underline; }
        #next-lesson-container a {
            display: block; background: var(--accent-gold); color: var(--bg-slate);
            padding: 12px 20px; border-radius: 8px; font-weight: 700; text-align: center;
            transition: background-color 0.3s;
        }
        #next-lesson-container a:hover { background-color: #b88b2a; text-decoration: none; }

        /* --- Lesson Content --- */
        #lesson-content h2 { font-size: 28px; color: var(--accent-gold); margin-top: 40px; margin-bottom: 16px; padding-top: 80px; margin-top: -64px; }
        #lesson-content p { font-family: var(--font-body); font-size: 17px; margin-bottom: 16px; }

        /* --- NEW: Enhanced Quiz Design --- */
        .quiz-section { background: #fff; border: 1px solid var(--accent-ink); border-radius: 8px; padding: 24px; margin-top: 40px; }
        .quiz-section h3 { margin-bottom: 16px; }
        .quiz-section p.prompt { font-weight: 700; margin-bottom: 16px; }
        .quiz-options { display: flex; flex-direction: column; gap: 12px; }
        .quiz-options label {
            display: block; padding: 12px 16px; border: 1px solid #e2e8f0;
            border-radius: 6px; cursor: pointer; transition: all 0.2s;
        }
        .quiz-options label:hover { border-color: var(--accent-gold); background: #fffaf0; }
        .quiz-options input[type="radio"] { display: none; } /* Hide the default radio button */
        .quiz-options input[type="radio"]:checked + span { font-weight: 700; color: var(--accent-gold); }
        .quiz-options label.correct { border-color: var(--success-green); background: #f0fff4; }
        .quiz-options label.incorrect { border-color: var(--error-red); background: #fff5f5; }
        .feedback { margin-top: 16px; padding: 12px; border-radius: 4px; font-weight: 500; }
        .feedback.correct { color: var(--success-green); background-color: #f0fff4; }
        .feedback.incorrect { color: var(--error-red); background-color: #fff5f5; }

        /* Responsive adjustments */
        @media (max-width: 900px) {
            .lesson-layout { grid-template-columns: 1fr; }
            #toc-container {
                position: static;
                order: -1; /* Move TOC to the top on mobile */
                margin-bottom: 32px;
                background: #fff; padding: 16px; border-radius: 8px;
            }
            #lesson-content h2 { padding-top: 64px; margin-top: -64px; }
        }
        
        /* Unchanged header/footer/etc. for brevity */
        header, footer {box-sizing: border-box;}
        header { background: var(--bg-slate); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); z-index: 1000; height: 64px; position: fixed; top: 0; left: 0; right: 0; }
        body { padding-top: 64px; }
        .exit-link svg { width: 24px; height: 24px; stroke: var(--accent-ink); transition: stroke 0.2s; } .exit-link:hover svg { stroke: var(--accent-gold); } .brand-group { display: flex; align-items: center; } .brand-text { color: var(--panel-cream); font-weight: 600; font-size: 20px; margin-left: 8px; } header .logo { width: 32px; height: 32px; } footer { text-align: center; padding: 24px 0 16px 0; background: var(--bg-slate); color: var(--accent-ink); font-size: 14px; margin-top: 48px; }
    </style>
</head>
<body>
    <header>
        <a href="./academy.html" class="exit-link" title="Return to The Academy Hub"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></a>
        <div class="brand-group"><svg class="logo" viewBox="0 0 24 24"><path d="M12 2 L2 22 H22 Z M12 6 L18.3 18 H5.7 Z" fill="var(--accent-gold)"/></svg><span class="brand-text">The Academy</span></div>
    </header>

    <div class="lesson-layout">
        <nav id="toc-container"></nav>
        
        <main id="lesson-container">
            <div id="prerequisites-container"></div>
            
            <div id="lesson-header"></div>
            <div id="lesson-content"></div>
            
            <div id="next-lesson-container"></div>
            
            <div id="lesson-spark"></div>
        </main>
    </div>

    <footer><p>© 2025 Boluadeoye • Crafted with passion</p></footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const db = await fetchDatabase();
            if (!db) { document.getElementById('lesson-header').innerHTML = '<h1>Error: Could not load lesson data.</h1>'; return; }
            
            const params = new URLSearchParams(window.location.search);
            const topicId = params.get('id') || 'gram001';
            
            await renderLesson(topicId, db);
            feather.replace({ 'stroke-width': 1.5, width: 18, height: 18 });
        });

        async function fetchDatabase() {
            try {
                const response = await fetch('./academy-data.json');
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                return (await response.json()).topics;
            } catch (error) { console.error('Failed to load db:', error); return null; }
        }

        async function renderLesson(topicId, db) {
            const topic = db[topicId];
            if (!topic) { /* ... */ return; }
            
            // --- 1. RENDER HEADER AND METADATA ---
            const headerTarget = document.getElementById('lesson-header');
            headerTarget.innerHTML = `
                <h1>${topic.title}</h1>
                <p class="summary">${topic.summary}</p>
                <div class="metadata">
                    <span class="difficulty difficulty-${topic.difficulty.toLowerCase()}">
                        <i data-feather="bar-chart-2"></i> ${topic.difficulty}
                    </span>
                    <span><i data-feather="clock"></i> ${topic.estimatedTime} mins</span>
                </div>`;

            // --- 2. RENDER MAIN CONTENT ---
            const contentTarget = document.getElementById('lesson-content');
            contentTarget.innerHTML = '';
            if (topic.contentFile) {
                try {
                    const response = await fetch(`lessons/${topic.contentFile}`);
                    const markdownText = await response.text();
                    contentTarget.innerHTML = marked.parse(markdownText);
                } catch (error) { contentTarget.innerHTML = '<p>Could not load lesson content.</p>'; }
            }
            if (topic.contentSections && topic.contentSections.length > 0) {
                topic.contentSections.forEach(section => contentTarget.appendChild(sectionRenderers[section.sectionType](section, topicId, db)));
            }

            // --- 3. GENERATE TABLE OF CONTENTS ---
            generateTOC(contentTarget);
            
            // --- 4. RENDER GUIDED NAVIGATION ---
            renderPrerequisites(topic.prerequisites, db);
            renderNextLesson(topic.unlocks, db);

            // --- 5. RENDER SPARK ---
            const sparkTarget = document.getElementById('lesson-spark');
            if (topic.insightSpark) { sparkTarget.innerHTML = `<h3>✨ Insight Spark</h3><p>${topic.insightSpark}</p>`; }
        }

        function generateTOC(contentEl) {
            const tocContainer = document.getElementById('toc-container');
            const headings = contentEl.querySelectorAll('h2');
            if (headings.length < 2) { tocContainer.style.display = 'none'; return; }

            let tocHTML = '<h3>In This Lesson</h3><ul>';
            headings.forEach((h, index) => {
                const id = `section-${index}`;
                h.id = id;
                tocHTML += `<li><a href="#${id}">${h.textContent}</a></li>`;
            });
            tocHTML += '</ul>';
            tocContainer.innerHTML = tocHTML;
        }
        
        function renderPrerequisites(prereqs, db) {
            const container = document.getElementById('prerequisites-container');
            if (!prereqs || prereqs.length === 0) { container.style.display = 'none'; return; }
            
            let linksHTML = prereqs.map(id => {
                const prereqTopic = db[id];
                return prereqTopic ? `<a href="lesson.html?id=${id}">${prereqTopic.title}</a>` : '';
            }).join(', ');

            if (linksHTML) {
                container.innerHTML = `<div class="nav-box"><h3>Before You Begin</h3><p>This lesson builds on concepts from: ${linksHTML}</p></div>`;
            }
        }
        
        function renderNextLesson(unlocks, db) {
            const container = document.getElementById('next-lesson-container');
            if (!unlocks || unlocks.length === 0) { container.style.display = 'none'; return; }

            const nextTopic = db[unlocks[0]]; // Assume first unlock is the next lesson
            if (nextTopic) {
                container.innerHTML = `<a href="lesson.html?id=${nextTopic.id}">Continue Your Journey →<br><small>${nextTopic.title}</small></a>`;
            }
        }

        const sectionRenderers = {
            quiz: (section, topicId, db) => {
                const quizContainer = document.createElement('div');
                quizContainer.className = 'quiz-section';
                quizContainer.innerHTML = section.content ? `<h3>${section.content}</h3>` : '';
                
                section.interactions.forEach(interaction => {
                    const block = document.createElement('div');
                    block.className = 'interaction-block';
                    const prompt = document.createElement('p');
                    prompt.className = 'prompt';
                    prompt.textContent = interaction.prompt;
                    block.appendChild(prompt);
                    
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'quiz-options';
                    
                    interaction.options.forEach((option, index) => {
                        const label = document.createElement('label');
                        label.htmlFor = `${interaction.id}-${index}`;
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.id = `${interaction.id}-${index}`;
                        input.name = interaction.id;
                        input.value = option;
                        const span = document.createElement('span');
                        span.textContent = option;
                        label.appendChild(input);
                        label.appendChild(span);
                        optionsDiv.appendChild(label);
                    });
                    
                    const submitBtn = document.createElement('button');
                    submitBtn.type = 'button';
                    submitBtn.textContent = 'Check Answer';
                    submitBtn.onclick = () => handleQuizSubmit(interaction, optionsDiv, topicId, db);

                    block.appendChild(optionsDiv);
                    block.appendChild(submitBtn);
                    quizContainer.appendChild(block);
                });
                return quizContainer;
            }
        };

        const handleQuizSubmit = (interaction, optionsDiv, topicId, db) => {
            const selected = optionsDiv.querySelector(`input[name="${interaction.id}"]:checked`);
            if (!selected) { alert('Please select an answer.'); return; }

            const allLabels = optionsDiv.querySelectorAll('label');
            allLabels.forEach(label => {
                const radio = label.querySelector('input');
                if (radio.value === interaction.correctAnswer) {
                    label.classList.add('correct');
                } else if (radio.checked) {
                    label.classList.add('incorrect');
                }
            });

            optionsDiv.parentElement.querySelectorAll('button, input').forEach(el => el.disabled = true);
            markLessonAsComplete(topicId);
            renderNextLesson(db[topicId].unlocks, db); // Re-render next lesson button to make it appear
        };

        const markLessonAsComplete = (topicId) => {
            let completed = JSON.parse(localStorage.getItem('academyProgress')) || [];
            if (!completed.includes(topicId)) {
                completed.push(topicId);
                localStorage.setItem('academyProgress', JSON.stringify(completed));
            }
        };
    </script>
</body>
</html>
