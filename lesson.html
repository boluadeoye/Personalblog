<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson - The Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:ital@0;1&family=Source+Sans+Pro&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { background-color: #FDFDFD; font-family: 'Lora', serif; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        .ui-font { font-family: 'Source Sans Pro', sans-serif; }
        header { background-color: #001F3F; }
        #lesson-content h2 { font-size: 28px; color: #001F3F; margin-top: 40px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb; }
        #lesson-content p { font-size: 18px; line-height: 1.8; margin-bottom: 1.5rem; }
        #lesson-content img { max-width: 100%; height: auto; border-radius: 8px; margin: 24px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sidebar { background-color: #f9fafb; }
        .distraction-free .sidebar { transform: translateX(100%); }
        .distraction-free main { padding-right: 0; }
    </style>
</head>
<body class="text-gray-800 transition-all duration-300">

    <header class="text-white shadow-lg fixed top-0 left-0 right-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="./index.html" class="flex items-center gap-2">
                    <svg class="h-8 w-8" viewBox="0 0 24 24"><path d="M12 2 L2 22 H22 Z M12 6 L18.3 18 H5.7 Z" fill="#D4AF37"/></svg>
                    <span class="font-bold text-xl">The Academy</span>
                </a>
                <div id="auth-nav" class="text-sm ui-font"></div>
            </div>
        </nav>
    </header>

    <div class="flex pt-16">
        <main class="w-full lg:w-2/3 xl:w-3/4 px-6 md:px-12 py-12 transition-all duration-300">
            <div id="lesson-container" class="max-w-4xl mx-auto">
                <p class="text-center text-gray-500">Loading lesson...</p>
            </div>
        </main>
        <aside class="sidebar w-full lg:w-1/3 xl:w-1/4 h-screen sticky top-16 border-l p-8 transition-transform duration-300">
            <h2 class="text-2xl font-bold mb-6" style="color: #001F3F;">Lesson Tools</h2>
            <div id="sidebar-content">
                <p class="ui-font text-gray-500">Loading tools...</p>
            </div>
        </aside>
    </div>

    <script type="module">
        import { auth, database } from './auth.js';

        const lessonContainer = document.getElementById('lesson-container');
        const sidebarContent = document.getElementById('sidebar-content');
        const authNav = document.getElementById('auth-nav');
        
        // Handle login/logout button
        auth.onAuthStateChange(user => {
            if (user) {
                authNav.innerHTML = `<button id="logout-btn" class="font-bold hover:underline" style="color: #D4AF37;">Logout</button>`;
                document.getElementById('logout-btn').addEventListener('click', () => auth.logout());
            } else {
                authNav.innerHTML = `<a href="./login.html" class="font-bold hover:underline">Member Login</a>`;
            }
        });

        async function renderLesson(lesson) {
            // Render main content
            let contentHtml = `<h1 class="text-5xl font-bold mb-4" style="color: #001F3F;">${lesson.title}</h1>`;
            contentHtml += `<p class="text-lg text-gray-600 mb-8 italic">${lesson.summary}</p>`;
            
            try {
                const response = await fetch(`./lessons/${lesson.id}/content.md`);
                if (!response.ok) throw new Error('Markdown content not found.');
                const markdown = await response.text();
                marked.setOptions({ baseUrl: `./lessons/${lesson.id}/` });
                contentHtml += `<div id="lesson-content">${marked.parse(markdown)}</div>`;
            } catch (error) {
                contentHtml += `<p class="text-red-500">Error: Lesson content could not be loaded.</p>`;
                console.error(error);
            }
            lessonContainer.innerHTML = contentHtml;

            // Render sidebar
            sidebarContent.innerHTML = `
                <div class="space-y-6 ui-font">
                    <div>
                        <h3 class="font-bold text-gray-700">Difficulty</h3>
                        <p>${lesson.difficulty}</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700">Estimated Time</h3>
                        <p>${lesson.estimated_time} minutes</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700">Learning Objectives</h3>
                        <ul class="list-disc list-inside text-gray-600">
                            ${(lesson.learning_objectives || []).map(obj => `<li>${obj}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            feather.replace();
        }

        function renderLockedState(lesson) {
            lessonContainer.innerHTML = `
                <h1 class="text-5xl font-bold mb-4" style="color: #001F3F;">${lesson.title}</h1>
                <div class="text-center p-8 border-2 border-dashed rounded-lg mt-8">
                    <h3 class="text-2xl font-bold text-gray-900">ðŸ”’ Premium Content</h3>
                    <p class="mt-2 text-gray-600">This lesson is part of the premium library. Please sign in to access.</p>
                    <a href="./login.html" class="mt-6 inline-block rounded-md px-6 py-3 text-white font-bold ui-font" style="background-color: #001F3F;">Member Login</a>
                </div>
            `;
            sidebarContent.innerHTML = `<p class="ui-font text-gray-500">Log in to view lesson tools.</p>`;
        }

        // --- Main Execution ---
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const lessonId = params.get('id');

            if (!lessonId) {
                lessonContainer.innerHTML = '<h1>Error: No lesson ID provided.</h1>';
                return;
            }

            const { data: lesson, error } = await database.getSingleLesson(lessonId);
            
            if (error || !lesson) {
                console.error('Error fetching lesson:', error);
                // Attempt to fetch public info for a better locked message
                const publicResponse = await fetch('./academy-data.json');
                const publicDb = await publicResponse.json();
                const publicLesson = publicDb.topics[lessonId];
                if (publicLesson) {
                    renderLockedState(publicLesson);
                } else {
                    lessonContainer.innerHTML = '<h1>Lesson not found or you do not have access.</h1>';
                }
            } else {
                renderLesson(lesson);
            }
        });
    </script>
</body>
</html>
